= Oura Ring Automation via ADB
:toc:
:toclevels: 3
:sectnums:

== Overview

This document describes the automation process for connecting to and controlling an Oura Ring 4 from a PC via an Android phone acting as a BLE bridge.

== Architecture

[source]
----
PC (Linux) --[USB/ADB]--> Android Phone --[BLE]--> Oura Ring 4
----

The Android app (`ReverseOura`) runs on the phone and exposes an ADB broadcast receiver that accepts commands from the PC.

== Prerequisites

=== Hardware
- Android phone with BLE support (tested on Xiaomi M2102J20SG, Android 11)
- Oura Ring 4
- USB cable connecting phone to PC

=== Software
- Android SDK with ADB
- Java 17+ for building Android app
- Android app installed: `com.example.reverseoura`

== ADB Command Interface

All commands are sent via ADB broadcasts:

[source,bash]
----
adb shell am broadcast -a com.example.reverseoura.COMMAND --es cmd "<command>"
----

=== Available Commands

|===
| Command | Description | Prerequisites

| `connect` or `scan`
| Scan for and connect to Oura Ring
| None

| `disconnect`
| Disconnect from ring
| None

| `status`
| Show connection/auth status
| None

| `auth`
| Authenticate with ring
| Connected, auth key set

| `setauth` or `set_auth_key`
| Write test auth key to ring
| Connected (will auto-connect)

| `set_key:HEXKEY`
| Set auth key in app memory (32 hex chars)
| None

| `send_hex:HEXDATA`
| Send raw hex command to ring
| Connected

| `heartbeat` or `start_hb`
| Start heartbeat capture
| Connected and authenticated

| `stop` or `stop_hb`
| Stop monitoring
| None

| `data` or `get_data`
| Get data from ring
| Connected and authenticated

| `sleep` or `get_sleep`
| Get sleep data
| Connected and authenticated

| `synctime` or `sync_time`
| Sync time with ring
| Connected and authenticated

| `factoryreset` or `factory_reset`
| Factory reset ring (erases all data!)
| Connected

| `export` or `export_data`
| Export captured events to file for PC analysis
| Events captured (after `data` command)
|===

== Connection Process

=== Step 1: Build and Install App

[source,bash]
----
cd android_app
JAVA_HOME=/usr/lib/jvm/java-21-openjdk ./gradlew assembleDebug
adb install -r app/build/outputs/apk/debug/app-debug.apk
----

=== Step 2: Launch App

[source,bash]
----
adb shell am start -n com.example.reverseoura/.MainActivity
----

=== Step 3: Start Log Monitoring

[source,bash]
----
adb logcat -s OuraRing:D ReverseOura:D
----

=== Step 4: Connect to Ring

[source,bash]
----
adb shell am broadcast -a com.example.reverseoura.COMMAND --es cmd "connect"
----

The app will:
1. Scan for bonded Oura devices first
2. If none found, scan BLE for devices with "Oura" in name
3. If device not bonded, initiate pairing via `createBond()`

=== Step 5: Handle Pairing (if needed)

After factory reset, the ring goes into setup mode and advertises as "Oura XXXXXXXXXXXXXXXX".
On different devices/scenarios, pairing prompts may appear in different ways:

==== Type 1: Modal Dialog (appears on top)
After factory reset, a system pairing dialog may appear on top of all apps.
[source,bash]
----
# Wait for ring found and createBond(), then quickly dump UI
adb shell uiautomator dump /sdcard/pair.xml
adb pull /sdcard/pair.xml
grep -E "(Pair|pair|Cancel)" pair.xml
----

==== Type 2: Notification (MIUI/Xiaomi)
Pairing may appear as a notification with "Pair & connect" action.
[source,bash]
----
# Check for Bluetooth pairing notification
adb shell dumpsys notification | grep -i "bluetooth\|pair"

# Expand notification shade
adb shell cmd statusbar expand-notifications

# Dump UI and find the "Pair & connect" button
adb shell uiautomator dump /sdcard/notif.xml
adb pull /sdcard/notif.xml
grep -oP 'text="Pair.*bounds="\[(\d+),(\d+)\]\[(\d+),(\d+)\]"' notif.xml
----

After finding bounds, click the button:
[source,bash]
----
adb shell input tap X Y
----

==== Waking Up the Ring
If the ring stops advertising after failed pairing attempts:
- Place ring on charger briefly (~5 seconds)
- Touch the ring's sensors
- Wait ~30 seconds and try scanning again

=== Step 6: Authentication

After factory reset, ring has no auth key. Set one:

[source,bash]
----
# Write test auth key to ring
adb shell am broadcast -a com.example.reverseoura.COMMAND --es cmd "setauth"

# Or set a specific key (32 hex chars = 16 bytes)
adb shell am broadcast -a com.example.reverseoura.COMMAND --es cmd "set_key:00426ed816dcece48dd9968c1f36c0b5"

# Then authenticate
adb shell am broadcast -a com.example.reverseoura.COMMAND --es cmd "auth"
----

== BLE Characteristics

Oura Service UUID: `98ed0001-a541-11e4-b6a0-0002a5d5c51b`

|===
| Characteristic | UUID | Description

| Write
| `98ed0002-a541-11e4-b6a0-0002a5d5c51b`
| Send commands to ring

| Notify
| `98ed0003-a541-11e4-b6a0-0002a5d5c51b`
| Receive responses from ring
|===

== Known Issues

=== BLE Privacy / Rotating MAC Address
The ring uses BLE Privacy (RPA - Resolvable Private Addresses). The MAC address changes approximately every 15 minutes. The app matches by device name containing "Oura" rather than fixed MAC.

=== MIUI Pairing Dialog
On Xiaomi phones running MIUI, the Bluetooth pairing prompt appears as a notification instead of a modal dialog. Automation requires expanding the notification shade and clicking "Pair & connect".

=== Ring Advertising
After factory reset, ring advertises as "Oura XXXXXXXXXXXXXXXX" (setup mode name). If pairing fails multiple times, the ring may stop advertising. To wake it:
- Place ring on charger briefly
- Touch the ring sensors

=== Bond State After Factory Reset
Factory reset clears the auth key from the ring but Android may still have stale bond info. If connection fails with status 22 (GATT_CONN_TERMINATE_PEER_USER), remove the old bond from Android Bluetooth settings.

== Automation Script Example

[source,bash]
----
#!/bin/bash
DEVICE="fba13a79"  # Your device ID

send_cmd() {
    adb -s $DEVICE shell am broadcast -a com.example.reverseoura.COMMAND --es cmd "$1"
}

wait_for_connected() {
    for i in {1..30}; do
        status=$(adb -s $DEVICE logcat -d -s OuraRing:D | grep -c "CONNECTION COMPLETE")
        if [ $status -gt 0 ]; then
            return 0
        fi
        sleep 1
    done
    return 1
}

# Main flow
echo "Launching app..."
adb -s $DEVICE shell am start -n com.example.reverseoura/.MainActivity

echo "Clearing logcat..."
adb -s $DEVICE logcat -c

echo "Connecting to ring..."
send_cmd "connect"

if wait_for_connected; then
    echo "Connected! Setting auth key..."
    send_cmd "setauth"
    sleep 3

    echo "Authenticating..."
    send_cmd "auth"
    sleep 3

    echo "Starting heartbeat capture..."
    send_cmd "heartbeat"
else
    echo "Connection failed"
fi
----

== Protocol Reference

See `docs/protocol/auth_protocol_spec.md` for authentication protocol details.

== Future Improvements

1. Auto-detect and click MIUI pairing notification
2. Background service to maintain connection
3. Wake lock to prevent phone sleep
4. PC-side daemon for automatic reconnection
